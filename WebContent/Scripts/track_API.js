$("#showBDBtn").click(function() {
    var obj = {};
    obj.gpsCode = $("#plateNumber").val();
    obj.startTime = transferDate($("#startDate").val()) + ' ' + $("#startTime").val();
    obj.endTime = transferDate($("#endDate").val()) + ' ' + $("#endTime").val();
    console.log(obj);
    initMap(obj);

});

function transferDate(str) {
    return str.split('/').join('-');
}


function initMap(obj) {
	console.log(obj);
    $.ajax({
         url: "baiduAPI_getPath.action",
         type: "POST",
//        type: "post",
//        async: false,
//        url: "http://api.k780.com/?app=phone.get&appkey=10003&sign=b59bc3ef6191eb9f747dd4e83c99f2a4&format=json",
//        data: "phone=15074872908",
        data: {gpsf:JSON.stringify(obj)},
//        dataType: "jsonp",
//        jsonp: "jsoncallback", //传递给请求处理程序或页面的，用以获得jsonp回调函数名的参数名(默认为:callback)
//        jsonpCallback: "success_jsonpCallback", //自定义的jsonp回调函数名称，默认为jQuery自动生成的随机函数名

        success: function(data) {
            var pts = JSON.parse(data);
            console.log(pts);
//            var pts = [{
//                "lng": "121.44593",
//                "lat": "29.384918"
//            }, {
//                "lng": "121.445541",
//                "lat": "29.384985"
//            }, {
//                "lng": "121.442068",
//                "lat": "29.387878"
//            }, {
//                "lng": "121.427611",
//                "lat": "29.421128"
//            }, {
//                "lng": "121.423153",
//                "lat": "29.461975"
//            }, {
//                "lng": "121.413843",
//                "lat": "29.502953"
//            }, {
//                "lng": "121.41996",
//                "lat": "29.544958"
//            }, {
//                "lng": "121.425578",
//                "lat": "29.588145"
//            }, {
//                "lng": "121.452378",
//                "lat": "29.632166"
//            }, {
//                "lng": "121.468396",
//                "lat": "29.671523"
//            }, {
//                "lng": "121.489791",
//                "lat": "29.70982"
//            }, {
//                "lng": "121.518253",
//                "lat": "29.745678"
//            }, {
//                "lng": "121.548476",
//                "lat": "29.780468"
//            }, {
//                "lng": "121.577751",
//                "lat": "29.816935"
//            }, {
//                "lng": "121.61678",
//                "lat": "29.836481"
//            }, {
//                "lng": "121.668871",
//                "lat": "29.835528"
//            }, {
//                "lng": "121.721443",
//                "lat": "29.82877"
//            }, {
//                "lng": "121.760623",
//                "lat": "29.850606"
//            }, {
//                "lng": "121.799608",
//                "lat": "29.885333"
//            }, {
//                "lng": "121.828416",
//                "lat": "29.915795"
//            }, {
//                "lng": "121.840596",
//                "lat": "29.93081"
//            }, {
//                "lng": "121.839215",
//                "lat": "29.933603"
//            }, {
//                "lng": "121.834228",
//                "lat": "29.937881"
//            }, {
//                "lng": "121.833915",
//                "lat": "29.937631"
//            }, {
//                "lng": "121.833558",
//                "lat": "29.93806"
//            }, {
//                "lng": "121.841108",
//                "lat": "29.941463"
//            }, {
//                "lng": "121.840351",
//                "lat": "29.941661"
//            }, {
//                "lng": "121.833471",
//                "lat": "29.938048"
//            }, {
//                "lng": "121.838248",
//                "lat": "29.936931"
//            }, {
//                "lng": "121.831971",
//                "lat": "29.935736"
//            }, {
//                "lng": "121.83614",
//                "lat": "29.933145"
//            }, {
//                "lng": "121.839526",
//                "lat": "29.935873"
//            }, {
//                "lng": "121.83228",
//                "lat": "29.934486"
//            }, {
//                "lng": "121.8388",
//                "lat": "29.933571"
//            }, {
//                "lng": "121.83895",
//                "lat": "29.939088"
//            }, {
//                "lng": "121.838391",
//                "lat": "29.93935"
//            }, {
//                "lng": "121.832925",
//                "lat": "29.936691"
//            }, {
//                "lng": "121.832153",
//                "lat": "29.934605"
//            }, {
//                "lng": "121.83454",
//                "lat": "29.933676"
//            }, {
//                "lng": "121.836426",
//                "lat": "29.933073"
//            }, {
//                "lng": "121.860368",
//                "lat": "29.923498"
//            }, {
//                "lng": "121.867906",
//                "lat": "29.912971"
//            }, {
//                "lng": "121.878713",
//                "lat": "29.893461"
//            }, {
//                "lng": "121.923333",
//                "lat": "29.886015"
//            }, {
//                "lng": "121.939946",
//                "lat": "29.878523"
//            }, {
//                "lng": "121.97836",
//                "lat": "29.882763"
//            }, {
//                "lng": "122.00675",
//                "lat": "29.8682"
//            }, {
//                "lng": "122.025191",
//                "lat": "29.885141"
//            }, {
//                "lng": "122.05125",
//                "lat": "29.881036"
//            }, {
//                "lng": "122.051248",
//                "lat": "29.883041"
//            }, {
//                "lng": "122.049713",
//                "lat": "29.880938"
//            }, {
//                "lng": "122.05385",
//                "lat": "29.882421"
//            }, {
//                "lng": "122.050686",
//                "lat": "29.881738"
//            }, {
//                "lng": "122.050245",
//                "lat": "29.881245"
//            }, {
//                "lng": "122.045933",
//                "lat": "29.882635"
//            }, {
//                "lng": "122.046748",
//                "lat": "29.881823"
//            }, {
//                "lng": "122.032031",
//                "lat": "29.876686"
//            }, {
//                "lng": "122.024581",
//                "lat": "29.868746"
//            }, {
//                "lng": "121.983146",
//                "lat": "29.863883"
//            }, {
//                "lng": "121.929251",
//                "lat": "29.866638"
//            }, {
//                "lng": "121.881816",
//                "lat": "29.867026"
//            }, {
//                "lng": "121.829585",
//                "lat": "29.879663"
//            }, {
//                "lng": "121.787723",
//                "lat": "29.874698"
//            }, {
//                "lng": "121.752176",
//                "lat": "29.845223"
//            }, {
//                "lng": "121.707873",
//                "lat": "29.830551"
//            }, {
//                "lng": "121.657886",
//                "lat": "29.837806"
//            }, {
//                "lng": "121.608588",
//                "lat": "29.835705"
//            }, {
//                "lng": "121.576923",
//                "lat": "29.815958"
//            }, {
//                "lng": "121.547851",
//                "lat": "29.779776"
//            }, {
//                "lng": "121.516925",
//                "lat": "29.74455"
//            }, {
//                "lng": "121.487301",
//                "lat": "29.706016"
//            }, {
//                "lng": "121.46357",
//                "lat": "29.66607"
//            }, {
//                "lng": "121.448123",
//                "lat": "29.623816"
//            }, {
//                "lng": "121.42581",
//                "lat": "29.583776"
//            }, {
//                "lng": "121.42037",
//                "lat": "29.537883"
//            }, {
//                "lng": "121.412878",
//                "lat": "29.491078"
//            }, {
//                "lng": "121.42644",
//                "lat": "29.447625"
//            }, {
//                "lng": "121.429131",
//                "lat": "29.403868"
//            }, {
//                "lng": "121.444633",
//                "lat": "29.384983"
//            }, {
//                "lng": "121.444918",
//                "lat": "29.38447"
//            }, {
//                "lng": "121.448595",
//                "lat": "29.378935"
//            }, {
//                "lng": "121.434725",
//                "lat": "29.341616"
//            }, {
//                "lng": "121.402823",
//                "lat": "29.31141"
//            }, {
//                "lng": "121.36081",
//                "lat": "29.289306"
//            }, {
//                "lng": "121.324711",
//                "lat": "29.25684"
//            }, {
//                "lng": "121.308845",
//                "lat": "29.21582"
//            }, {
//                "lng": "121.311781",
//                "lat": "29.175991"
//            }, {
//                "lng": "121.292163",
//                "lat": "29.137326"
//            }, {
//                "lng": "121.304508",
//                "lat": "29.093563"
//            }, {
//                "lng": "121.275298",
//                "lat": "29.06419"
//            }, {
//                "lng": "121.227843",
//                "lat": "29.048936"
//            }, {
//                "lng": "121.225345",
//                "lat": "29.022485"
//            }, {
//                "lng": "121.216961",
//                "lat": "28.965883"
//            }, {
//                "lng": "121.223373",
//                "lat": "28.92131"
//            }, {
//                "lng": "121.222458",
//                "lat": "28.879026"
//            }, {
//                "lng": "121.226085",
//                "lat": "28.83993"
//            }, {
//                "lng": "121.235466",
//                "lat": "28.792243"
//            }, {
//                "lng": "121.231171",
//                "lat": "28.751761"
//            }, {
//                "lng": "121.239578",
//                "lat": "28.709671"
//            }, {
//                "lng": "121.236263",
//                "lat": "28.658155"
//            }, {
//                "lng": "121.239506",
//                "lat": "28.609993"
//            }, {
//                "lng": "121.239921",
//                "lat": "28.563825"
//            }, {
//                "lng": "121.245791",
//                "lat": "28.513493"
//            }, {
//                "lng": "121.246225",
//                "lat": "28.4725"
//            }, {
//                "lng": "121.279158",
//                "lat": "28.45543"
//            }, {
//                "lng": "121.325176",
//                "lat": "28.443973"
//            }, {
//                "lng": "121.348938",
//                "lat": "28.437435"
//            }, {
//                "lng": "121.386446",
//                "lat": "28.43387"
//            }, {
//                "lng": "121.384585",
//                "lat": "28.403818"
//            }, {
//                "lng": "121.389223",
//                "lat": "28.362975"
//            }, {
//                "lng": "121.377268",
//                "lat": "28.344695"
//            }, {
//                "lng": "121.345651",
//                "lat": "28.325825"
//            }, {
//                "lng": "121.304293",
//                "lat": "28.301593"
//            }, {
//                "lng": "121.278801",
//                "lat": "28.276256"
//            }, {
//                "lng": "121.271251",
//                "lat": "28.251396"
//            }, {
//                "lng": "121.265488",
//                "lat": "28.231246"
//            }, {
//                "lng": "121.254081",
//                "lat": "28.216055"
//            }, {
//                "lng": "121.260111",
//                "lat": "28.207336"
//            }, {
//                "lng": "121.259716",
//                "lat": "28.206945"
//            }, {
//                "lng": "121.26032",
//                "lat": "28.207346"
//            }, {
//                "lng": "121.260551",
//                "lat": "28.206996"
//            }, {
//                "lng": "121.262136",
//                "lat": "28.211038"
//            }, {
//                "lng": "121.260431",
//                "lat": "28.227151"
//            }, {
//                "lng": "121.271573",
//                "lat": "28.252023"
//            }, {
//                "lng": "121.281865",
//                "lat": "28.279716"
//            }, {
//                "lng": "121.307808",
//                "lat": "28.30357"
//            }, {
//                "lng": "121.33781",
//                "lat": "28.322208"
//            }, {
//                "lng": "121.369785",
//                "lat": "28.340293"
//            }, {
//                "lng": "121.381975",
//                "lat": "28.358311"
//            }, {
//                "lng": "121.388706",
//                "lat": "28.384223"
//            }, {
//                "lng": "121.385058",
//                "lat": "28.424106"
//            }, {
//                "lng": "121.372481",
//                "lat": "28.434853"
//            }, {
//                "lng": "121.33855",
//                "lat": "28.441753"
//            }, {
//                "lng": "121.318006",
//                "lat": "28.444701"
//            }, {
//                "lng": "121.280408",
//                "lat": "28.45491"
//            }, {
//                "lng": "121.246966",
//                "lat": "28.47244"
//            }, {
//                "lng": "121.243285",
//                "lat": "28.49096"
//            }, {
//                "lng": "121.246478",
//                "lat": "28.535221"
//            }, {
//                "lng": "121.238716",
//                "lat": "28.581788"
//            }, {
//                "lng": "121.239423",
//                "lat": "28.625071"
//            }, {
//                "lng": "121.237396",
//                "lat": "28.668183"
//            }, {
//                "lng": "121.24058",
//                "lat": "28.695076"
//            }, {
//                "lng": "121.231658",
//                "lat": "28.750068"
//            }, {
//                "lng": "121.234528",
//                "lat": "28.798608"
//            }, {
//                "lng": "121.224565",
//                "lat": "28.845506"
//            }, {
//                "lng": "121.224608",
//                "lat": "28.888903"
//            }, {
//                "lng": "121.222801",
//                "lat": "28.93077"
//            }, {
//                "lng": "121.219038",
//                "lat": "28.973711"
//            }, {
//                "lng": "121.225453",
//                "lat": "28.991825"
//            }, {
//                "lng": "121.246535",
//                "lat": "29.054728"
//            }, {
//                "lng": "121.295103",
//                "lat": "29.069006"
//            }, {
//                "lng": "121.298555",
//                "lat": "29.109296"
//            }, {
//                "lng": "121.302645",
//                "lat": "29.151958"
//            }, {
//                "lng": "121.308401",
//                "lat": "29.191465"
//            }, {
//                "lng": "121.317385",
//                "lat": "29.234521"
//            }, {
//                "lng": "121.337675",
//                "lat": "29.272931"
//            }, {
//                "lng": "121.382196",
//                "lat": "29.302736"
//            }, {
//                "lng": "121.424076",
//                "lat": "29.332355"
//            }, {
//                "lng": "121.450815",
//                "lat": "29.369545"
//            }, {
//                "lng": "121.446166",
//                "lat": "29.38472"
//            }, {
//                "lng": "121.439663",
//                "lat": "29.389745"
//            }, {
//                "lng": "121.430275",
//                "lat": "29.431193"
//            }, {
//                "lng": "121.41573",
//                "lat": "29.472941"
//            }, {
//                "lng": "121.413963",
//                "lat": "29.512808"
//            }, {
//                "lng": "121.427191",
//                "lat": "29.571095"
//            }, {
//                "lng": "121.442595",
//                "lat": "29.617763"
//            }, {
//                "lng": "121.460948",
//                "lat": "29.662043"
//            }, {
//                "lng": "121.485383",
//                "lat": "29.70108"
//            }, {
//                "lng": "121.512203",
//                "lat": "29.736651"
//            }, {
//                "lng": "121.544781",
//                "lat": "29.772105"
//            }, {
//                "lng": "121.576475",
//                "lat": "29.814828"
//            }, {
//                "lng": "121.619768",
//                "lat": "29.837173"
//            }, {
//                "lng": "121.676465",
//                "lat": "29.833213"
//            }, {
//                "lng": "121.735",
//                "lat": "29.83232"
//            }, {
//                "lng": "121.775366",
//                "lat": "29.866651"
//            }, {
//                "lng": "121.808368",
//                "lat": "29.89796"
//            }, {
//                "lng": "121.839468",
//                "lat": "29.929556"
//            }, {
//                "lng": "121.85655",
//                "lat": "29.924833"
//            }, {
//                "lng": "121.858285",
//                "lat": "29.924308"
//            }, {
//                "lng": "121.859015",
//                "lat": "29.924101"
//            }, {
//                "lng": "121.86015",
//                "lat": "29.924331"
//            }, {
//                "lng": "121.860418",
//                "lat": "29.925046"
//            }, {
//                "lng": "121.861691",
//                "lat": "29.926908"
//            }, {
//                "lng": "121.861806",
//                "lat": "29.927166"
//            }, {
//                "lng": "121.863456",
//                "lat": "29.92949"
//            }];
            drawTrack(pts);

        },
        error: function(XMLHttpRequest, textStatus, errorThrown) {
            alert('初始化失败');
        }
    });

}


//绘制地图
function drawTrack(pts) {
    // 百度地图API功能
    var map = new BMap.Map("allmap");

    setZoom(pts);
    // map.centerAndZoom(getPointObj(pts[0]), 15);
    var myIcon = new BMap.Icon("http://sandbox.runjs.cn/uploads/rs/101/wmbvrxnx/kache.png", new BMap.Size(32, 70), { //小车图片
        //offset: new BMap.Size(0, -5),    //相当于CSS精灵
        // imageOffset: new BMap.Size(0, 0) //图片的偏移量。为了是图片底部中心对准坐标点。
        anchor: new BMap.Size(10, 10)
    });

    var idx = 0;
    var carMk = new BMap.Marker(getPointObj(pts[0]), {
        icon: myIcon
    });
    map.addOverlay(carMk);

    //设置间隔
    var tmp = setInterval(function() {
        if (idx == pts.length) {
            clearInterval(tmp);
        } else {
            drawIcon(idx);
            idx++;
        }

    }, 100);


    //生成下一个图标后删除上一个绘制的图标，形成小车移动动画感
    function drawIcon(index) {
        if (carMk) {
            map.removeOverlay(carMk);
        }
        carMk = new BMap.Marker(
            new getPointObj(pts[index]), //起始点的经纬度  
            {
                icon: myIcon
            });
        map.addOverlay(carMk);
        if (index < pts.length - 1) {
            drawGreenLine(index);
        }
    }

    function drawGreenLine(index) {
        var polyline = new BMap.Polyline([
            getPointObj(pts[index]), //起始点的经纬度  
            getPointObj(pts[index + 1]) //终止点的经纬度  
        ], {
            strokeColor: "#0172c2", //设置颜色   
            strokeWeight: 3, //宽度  
            strokeOpacity: 1
        }); //透明度  
        map.addOverlay(polyline);
    }

    //根据原始数据计算中心坐标和缩放级别，并为地图设置中心坐标和缩放级别。  
    function setZoom(points) {
        if (points.length > 0) {
            var maxLng = points[0].lng;
            var minLng = points[0].lng;
            var maxLat = points[0].lat;
            var minLat = points[0].lat;
            var res;
            for (var i = points.length - 1; i >= 0; i--) {
                res = points[i];
                if (res.lng > maxLng) maxLng = res.lng;
                if (res.lng < minLng) minLng = res.lng;
                if (res.lat > maxLat) maxLat = res.lat;
                if (res.lat < minLat) minLat = res.lat;
            };
            var cenLng = (parseFloat(maxLng) + parseFloat(minLng)) / 2;
            var cenLat = (parseFloat(maxLat) + parseFloat(minLat)) / 2;
            var zoom = getZoom(maxLng, minLng, maxLat, minLat);
            map.centerAndZoom(new BMap.Point(cenLng, cenLat), zoom);
        } else {
            //没有坐标，显示全中国  
            map.centerAndZoom(new BMap.Point(103.388611, 35.563611), 5);
        }
    }

    //根据经纬极值计算绽放级别。  
    function getZoom(maxLng, minLng, maxLat, minLat) {
        var zoom = ["50", "100", "200", "500", "1000", "2000", "5000", "10000", "20000", "25000", "50000", "100000", "200000", "500000", "1000000", "2000000"] //级别18到3。  
        var pointA = new BMap.Point(maxLng, maxLat); // 创建点坐标A  
        var pointB = new BMap.Point(minLng, minLat); // 创建点坐标B  
        var distance = map.getDistance(pointA, pointB).toFixed(1); //获取两点距离,保留小数点后两位  
        for (var i = 0, zoomLen = zoom.length; i < zoomLen; i++) {
            if (zoom[i] - distance > 0) {
                return 18 - i + 3; //之所以会多3，是因为地图范围常常是比例尺距离的10倍以上。所以级别会增加3。  
            }
        };
    }
}

function getPointObj(obj) {
    // console.log(obj);
    return new BMap.Point(obj.lng, obj.lat);
}